{% load static %} {% block styles %}
<link rel="stylesheet" href="{{ static 'main.css' }}" />
{% endblock %} {% block content %}
<script src="{% static 'colors.js' %}"></script>
<script src="{{ static 'global.js' }}"></script>

<style>
  /* Make unselected cards look dimmer */
  .option-card {
    opacity: 0.6;
    transition: all 0.2s ease;
    border: 2px solid #ccc;
  }

  /* Selected card pops out */
  .option-card.selected {
    opacity: 1 !important;
    border: 3px solid #000; /* thicker, darker border */
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.4); /* glow effect */
    transform: scale(1.03); /* slight zoom */
    z-index: 1; /* keep above others */
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const cards = document.querySelectorAll(".option-card");

    cards.forEach((card) => {
      const label = card.textContent.trim();

      if (COLORS[label]) {
        card.style.backgroundColor = COLORS[label];
        card.style.color =
          label === "FDP"
            ? "#424949"
            : COLORS[label] === "#c7c7c7"
            ? "black"
            : "white";
      }
    });

    // Force last two cards to span full width (two columns)
    const lastTwo = Array.from(cards).slice(-2);
    lastTwo.forEach((card) => {
      card.style.gridColumn = "1 / span 3";
    });
  });
</script>

<h2>{{page_title}}</h2>

<div class="card-section">
  <div class="card">
    <div class="form-group">
      <label class="form-label"> {{qu_identity}} </label>
      <div
        class="option-cards"
        data-field="feel_closest_party"
        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 9px"
      >
        {% for choice, label in choices_identity.items %}
        <label class="option-card">
          <input type="radio" name="feel_closest_party" value="{{ choice }}" />
          {{ label }}
        </label>
        {% endfor %}
      </div>
      {{ formfield_errors "feel_closest_party" }}
    </div>

    <p style="font-size: 8pt; color: gray">{{partytext}}</p>

    <p style="margin-bottom: -0.5em">{{qu_party_comment}}</p>

    {{formfield "party_comment"}}
  </div>
</div>

<div class="card-section">
  <div class="card">
    <label class="form-label">{{ lr_question }}</label>

    <div style="display: flex; justify-content: space-between; margin-top: 5px">
      <span style="font-size: 12pt; color: #777">{{ lr_first_label }}</span>
      <span style="font-size: 12pt; color: #777">{{ lr_last_label }}</span>
    </div>
    <input
      type="range"
      class="likert-slider"
      name="lrscale"
      id="sliderlr"
      min="-50"
      max="50"
      step="1"
      style="color: #aaaaaa; background: #ccc"
      oninput="handleSliderInput(this.value)"
      required
    />

    <div id="sliderValue" class="slider-label-container">
      <div class="slider-label-text" style="color: grey; text-align: center">
        {% if lan_en %}Please move the slider{% else %}Bitte bewegen Sie den
        Schieberegler{% endif %}
      </div>
      <div class="slider-num-info">
        <!-- keep empty space to reserve width -->
        <span class="sldier-num">&nbsp;</span>
      </div>
    </div>
    {{ formfield_errors "lrscale" }}
  </div>
</div>

<div class="nav-container">
  {% if lan_en %}
  <button type="submit" class="otree-btn-next btn btn-primary big-button">
    Continue
  </button>
  <div class="nav-progress">Page {{nslide}}/{{maxslides}}</div>
  {% else %}
  <button type="submit" class="otree-btn-next btn btn-primary big-button">
    Weiter
  </button>
  <div class="nav-progress">Seite {{nslide}}/{{maxslides}}</div>
  {% endif %}
</div>

<script>
  document.querySelectorAll(".option-cards").forEach((group) => {
    const name = group.dataset.field;
    group.querySelectorAll('input[type="radio"]').forEach((radio) => {
      radio.addEventListener("change", () => {
        group.querySelectorAll(".option-card").forEach((card) => {
          card.classList.remove("selected");
        });
        radio.closest(".option-card").classList.add("selected");
      });
    });
  });
</script>

<script>
  // Form validation before submission
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        if (!sliderTouched) {
          e.preventDefault();
          const lang = {% if lan_en %}true{% else %}false{% endif %};
          alert(lang ? 'Please move the slider to select a value.' : 'Bitte bewegen Sie den Schieberegler, um einen Wert auszuwählen.');
          return false;
        }
      });
    }
  });
</script>

<script>
  let sliderTouched = false;

  function handleSliderInput(value) {
    sliderTouched = true;

    // Update the displayed value
    let va = document.getElementById("sliderValue");
    va.innerHTML =
      `<div class="slider-label-container"><div class="slider-label-text">` +
      `{% if lan_en %}Selected:  {% else %}Ausgewählt: {%endif%}` +
      `<strong><span class="slider-num">${Math.round(
        value / 10
      )}</span></strong></div>{% if lan_en %}
             (on the scale from -5 to 5){% else %}  (auf der Skala von -5 bis 5){%endif%}` +
      `</div>`;
    va.style.color = "black";
    va.style.fontSize = "10pt";

    // Enable the next button
    const nextButton = document.getElementById("nextButton");
    if (nextButton) {
      nextButton.disabled = false;
      nextButton.style.opacity = "1";
    }

    // Update slider styling
    const slider = document.getElementById("sliderlr");
    const val = parseFloat(value);
    const min = parseFloat(slider.min),
      max = parseFloat(slider.max);
    const mid = (min + max) / 2;
    const sliderColor = "#424242ff";

    // compute fill percentages from center
    const l =
      val < mid ? Math.max(0, 50 + ((val - mid) / (mid - min)) * 50) : 50;
    const r =
      val < mid ? 50 : Math.min(100, 50 + ((val - mid) / (max - mid)) * 50);
    slider.style.color = "black";
    slider.style.background = `linear-gradient(to right,
        #e0e0e0 0%, #e0e0e0 ${l}%,
        ${sliderColor} ${l}%, ${sliderColor} ${r}%,
        #e0e0e0 ${r}%, #e0e0e0 100%)`;
  }
</script>

{% endblock %}
