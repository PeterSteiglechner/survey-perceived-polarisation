{% block styles %}
    <link rel="stylesheet" href="{{ static 'main.css' }}">
{% endblock %}


{{ block content }}

<style>
     .survey-table-clean thead {
     background: {{color}};
 }
</style>
<h2>{{page_title}}</h2>

<br>

<p style="font-size: 20px;"> {{instruction_text}}</p>


<form method="post">
    <table class="survey-table-clean">
        <thead background: {{color}} color:"white">
            <tr>
                <th style="width: 100%;{% if name == 'FDP' %}color:  #424949 ;rgb(255, 255, 255){% endif %}">{{table_head}}</th>
            </tr>
        </thead>
        <tbody>
                  {% for item in field_question_pairs %}
      <tr>
        <td>
          <label class="form-label"><b>{{ item.question_text }}</b></label>
          {% comment %} <p>{{ would_respond }}</p> {% endcomment %}
          <input
            type="range"
            class="likert-slider"
            name="{{ item.field_name }}"
            id="slider_{{ forloop.counter }}"
            min="-100"
            max="100"
            step="1"
            style="color: {{color}}; background: #ccc"
            oninput="handleSliderInput{{ forloop.counter }}(this.value)"
            required
          />
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
            "
          >
            <span style="font-size: 10pt; color: #777; margin-top: -3pt"
              >{{ item.first_label }}</span
            >
            <span style="font-size: 10pt; color: #777; margin-top: -3pt"
              >{{ item.neutral_label }}</span
            >
            <span style="font-size: 10pt; color: #777; margin-top: -3pt"
              >{{ item.last_label }}</span
            >
          </div>
          <div style="text-align: center; margin-top: 0pt; margin-bottom: 0pt">
            <span id="sliderValue{{ forloop.counter }}">
                  {% comment %} <td style="font-size: 12pt; text-align: center; width: 30%"> {% endcomment %}
                    {% comment %} {{would_respond}} {% endcomment %}
                    <p style="margin-top: 25pt; margin-bottom: 25pt">{% if lan_en %}Please move the slider{% else %}Bitte bewegen
                    Sie den Schieberegler{% endif %}
                    </p>
                  {% comment %} </td>
                  <td style="font-size: 12pt; text-align: center">
                  </td> {% endcomment %}
            </span>
          </div>
          {{ formfield_errors item.field_name }}
        </td>
      </tr>
      {% endfor %}
        </tbody>
    </table>

<div style="display: flex; justify-content: space-between; align-items: center;">
    {% if lan_en %}
        {{ next_button }}
        <div style="margin-left: auto;">Page {{nslide}}/{{maxslides}}</div>
    {% else %}
        <button type="submit" class="otree-btn-next btn btn-primary big-button">Weiter</button>
        <div style="margin-left: auto;">Seite {{nslide}}/{{maxslides}}</div>
    {% endif %}
</div>

</form>


<script>
  let slidersTouched = {};
  const totalSliders = {{ field_question_pairs|length }};

  {% for item in field_question_pairs %}

  function handleSliderInput{{ forloop.counter }}(value) {
      slidersTouched[{{ forloop.counter }}] = true;
      function getLikertLabel(val) {
          const numVal = parseInt(val);
          {% if lan_en %}
          if (numVal <= -71) return "Strongly Disagree";
          else if (numVal <= -41) return "Disagree";
          else if (numVal <= -11) return "Somewhat Disagree";
          else if (numVal <= 11) return "Neutral";
          else if (numVal <= 41) return "Somewhat Agree";
          else if (numVal <= 71) return "Agree";
          else return "Strongly Agree";
          {% else %}
          if (numVal <= -71) return "Stimme überhaupt nicht zu";
          else if (numVal <= -41) return "Stimme nicht zu";
          else if (numVal <= -11) return "Stimme eher nicht zu";
          else if (numVal <= 11) return "Neutral";
          else if (numVal <= 41) return "Stimme eher zu";
          else if (numVal <= 71) return "Stimme zu";
          else return "Stimme voll und ganz zu";
          {% endif %}
      }

      const label = getLikertLabel(value);

      {% if lan_en %}
      document.getElementById('sliderValue{{ forloop.counter }}').innerHTML =
        `<table style="width:100%; border-collapse:collapse;">
          <tr>
            <td style="font-size:12pt; text-align:center; width:30%;">{{would_respond}}</td>
            <td style="font-size:12pt; text-align:center;"><b>${label}</b></td>
            <td style="font-size:12pt; text-align:right;">around ${Math.round(value/10)} (on scale -10 to 10)</td>
          </tr>
        </table>`;
      {% else %}
      document.getElementById('sliderValue{{ forloop.counter }}').innerHTML =
        `<table style="width:100%; border-collapse:collapse;">
          <tr>
            <td style="font-size:12pt; text-align:center; width:30%;">{{would_respond}}</td>
            <td style="font-size:12pt; text-align:center; "><b>${label}</b></td>
            <td style="font-size:12pt; text-align:right;">ca. ${Math.round(value/10)} (auf der Skala von -10 bis 10)</td>
          </tr>
        </table>`;
      {% endif %}

      document.getElementById('sliderValue{{ forloop.counter }}').style.color = 'black';
     
      const slider = document.getElementById('slider_{{ forloop.counter }}');
      const val = parseFloat(value);
      const min = parseFloat(slider.min), max = parseFloat(slider.max);
      const mid = (min + max) / 2;
      const sliderColor = "{{color}}";

      // compute fill percentages from center
      const l = val < mid ? Math.max(0, 50 + ((val - mid) / (mid - min)) * 50) : 50;
      const r = val < mid ? 50 : Math.min(100, 50 + ((val - mid) / (max - mid)) * 50);

      slider.style.background = `linear-gradient(to right,
        #e0e0e0 0%, #e0e0e0 ${l}%, 
        ${sliderColor} ${l}%, ${sliderColor} ${r}%, 
        #e0e0e0 ${r}%, #e0e0e0 100%)`;


      if (Object.keys(slidersTouched).length === totalSliders) {
          const nextButton = document.getElementById('nextButton') || document.querySelector('.otree-btn-next');
          if (nextButton) {
              nextButton.disabled = false;
              nextButton.style.opacity = '1';
          }
      }
  }
  {% endfor %}

  document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form');
      if (form) {
          form.addEventListener('submit', function(e) {
              if (Object.keys(slidersTouched).length < totalSliders) {
                  e.preventDefault();
                  alert({% if lan_en %}'Please move all sliders to select values.'{% else %}'Bitte bewegen Sie alle Schieberegler, um Werte auszuwählen.'{% endif %});
                  return false;
              }
          });
      }
      const nextButton = document.getElementById('nextButton') || document.querySelector('.otree-btn-next');
      if (nextButton) {
          nextButton.disabled = true;
          nextButton.style.opacity = '0.5';
      }
  });
</script>
{% endblock %}
