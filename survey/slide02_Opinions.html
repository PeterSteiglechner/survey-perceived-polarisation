{% load static %} {% block styles %}
<link rel="stylesheet" href="{{ static 'main.css' }}" />
{% endblock %} {% block content %}
<script src="{{ static 'global.js' }}"></script>

<h2>{{ page_title }}</h2>

{{ instruction_text }}

<form method="post">
  <table class="survey-table-clean">
    <thead>
      <tr>
        <th style="width: 100%">{{ table_head }}</th>
      </tr>
    </thead>
    <tbody>
      {% for item in field_question_pairs %}
      <tr>
        <td>
          <label class="form-label"><b>{{ item.question_text }}</b></label>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr 1fr;
              margin-top: 5px;
              width: 100%;
            "
          >
            <span style="font-size: 10pt; color: #777; text-align: left"
              >{{ item.first_label }}</span
            >
            <span style="font-size: 10pt; color: #777; text-align: center"
              >{{ item.neutral_label }}</span
            >
            <span style="font-size: 10pt; color: #777; text-align: right"
              >{{ item.last_label }}</span
            >
          </div>

          <input
            type="range"
            class="likert-slider"
            name="{{ item.field_name }}"
            id="slider_{{ forloop.counter }}"
            min="-100"
            max="100"
            step="1"
            style="color: #aaaaaa; background: #ccc"
            oninput="handleSliderInput{{ forloop.counter }}(this.value)"
            required
          />

          <div style="text-align: center; margin-top: 0pt; margin-bottom: 0pt">
            <span id="sliderValue{{ forloop.counter }}">
              <p
                style="
                  margin-top: 0pt;
                  margin-bottom: 16pt;
                  color: #999;
                  font-size: 10pt;
                "
              >
                {% if lan_en %}Please move the slider{% else %}Bitte bewegen Sie
                den Schieberegler{% endif %}
              </p>
            </span>
          </div>
          {{ formfield_errors item.field_name }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

<div style="display: flex; justify-content: space-between; align-items: center">
  {% if lan_en %}
  <button type="submit" class="otree-btn-next btn btn-primary big-button">
    Continue
  </button>
  <div style="margin-left: auto">Page {{ nslide }}/{{ maxslides }}</div>
  {% else %}
  <button type="submit" class="otree-btn-next btn btn-primary big-button">
    Weiter
  </button>
  <div style="margin-left: auto">Seite {{ nslide }}/{{ maxslides }}</div>
  {% endif %}
</div>

<script>
  let slidersTouched = {};
  const totalSliders = {{ field_question_pairs|length }};

  {% for item in field_question_pairs %}
  function handleSliderInput{{ forloop.counter }}(value) {
      slidersTouched[{{ forloop.counter }}] = true;

      const label = getLikertLabel(value, "{{lan_en}}");

      {% if lan_en %}
      document.getElementById('sliderValue{{ forloop.counter }}').innerHTML =
        `<table style="width:100%; border-collapse:collapse; margin-top:-15pt">
          <tr>
            <td style="font-size:10pt; text-align:center; width:60%;">Selected:  <b>${label}</b></td>
            <td style="font-size:8pt; text-align:right;">around ${Math.round(value/10)} (on the scale from -10 to 10)</td>
          </tr>
        </table>`;
      {% else %}
      document.getElementById('sliderValue{{ forloop.counter }}').innerHTML =
        `<table style="width:100%; border-collapse:collapse; margin-top:-15pt">
          <tr>
            <td style="font-size:10pt; text-align:center; width:60%;">Ausgewählt:   <b>${label}</b></td>
            <td style="font-size:8pt; text-align:right;">ca. ${Math.round(value/10)} (auf der Skala von -10 bis 10)</td>
          </tr>
        </table>`;
      {% endif %}

      document.getElementById('sliderValue{{ forloop.counter }}').style.color = 'black';

      const slider = document.getElementById('slider_{{ forloop.counter }}');
      const val = parseFloat(value);
      const min = parseFloat(slider.min), max = parseFloat(slider.max);
      const mid = (min + max) / 2;
      const sliderColor = "#424242ff";

      // compute fill percentages from center
      const l = val < mid ? Math.max(0, 50 + ((val - mid) / (mid - min)) * 50) : 50;
      const r = val < mid ? 50 : Math.min(100, 50 + ((val - mid) / (max - mid)) * 50);

      slider.style.background = `linear-gradient(to right,
        #e0e0e0 0%, #e0e0e0 ${l}%,
        ${sliderColor} ${l}%, ${sliderColor} ${r}%,
        #e0e0e0 ${r}%, #e0e0e0 100%)`;



      if (Object.keys(slidersTouched).length === totalSliders) {
          const nextButton = document.getElementById('nextButton') || document.querySelector('.otree-btn-next');
          if (nextButton) {
              nextButton.disabled = false;
              nextButton.style.opacity = '1';
          }
      }
  }
  {% endfor %}

  document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('form');
      if (form) {
          form.addEventListener('submit', function(e) {
              if (Object.keys(slidersTouched).length < totalSliders) {
                  e.preventDefault();
                  alert({% if lan_en %}'Please move all sliders to select values.'{% else %}'Bitte bewegen Sie alle Schieberegler, um Werte auszuwählen.'{% endif %});
                  return false;
              }
          });
      }
      const nextButton = document.getElementById('nextButton') || document.querySelector('.otree-btn-next');
      if (nextButton) {
          nextButton.disabled = true;
          nextButton.style.opacity = '0.5';
      }
  });
</script>

{% endblock %}
