{% block styles %}
<link rel="stylesheet" href="{{ static 'main.css' }}" />
{% endblock %} {% block content %}
<script src="{{ static 'global.js' }}"></script>

<h2>{{ page_title }}</h2>
<style>
  .survey-table-clean thead {
    background: rgba(150, 150, 150);
  }

  .survey-table-clean td {
    padding: 3px;
    border-bottom: 1px solid #a8a8a8ff;
    vertical-align: center;
    font-size: 15px;
  }

  .survey-table-clean tr:hover {
    background-color: rgba(71, 98, 216, 0.05);
  }
</style>

<p>{{ instruction_text }}</p>

<p>{{would_respond}}</p>

<div
  class="instructions"
  style="
    margin: 10px 0;
    padding: 10px;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 4px;
  "
>
  {{instruction_bestguess}}
</div>

<form method="post">
  {% for q in questions %}
  <div class="question-block">
    {% comment %} <label><strong>{{ q.text }}</strong></label> {% endcomment %}
    <table class="survey-table-clean">
      <thead>
        <tr>
          <td></td>
          <th style="width: 65%">
            <label><strong>{{ q.text }}</strong></label>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="width: 35%"></td>
          <td style="width: 65%">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-top: 0.5em;
              "
            >
              <span style="font-size: 10pt; color: #000000ff"
                >{{ first_label }}</span
              >
              <span style="font-size: 10pt; color: #000000ff"
                >{{ neutral_label }}</span
              >
              <span style="font-size: 10pt; color: #000000ff"
                >{{ last_label }}</span
              >
            </div>
          </td>
        </tr>
        {% for c in contacts %}
        <tr>
          <td>
            <label class="form-label"> {{ c.name }} </label>
          </td>
          <td>
            <input
              type="range"
              class="likert-slider"
              name="{{ c.id }}_{{ q.prefix }}"
              id="slider_{{ q.prefix }}{{ c.id }}"
              min="-100"
              max="100"
              step="1"
              required
              oninput="handleSliderInput('{{ q.prefix }}{{ c.id }}', this.value)"
            />
            <div
              id="sliderValue{{ q.prefix }}{{ c.id }}"
              class="slider-label"
              style="text-align: center"
            >
              <p style="color: #999; font-size: 10pt; margin-top: 0pt">
                {% if lan_en %}Please move the slider{% else %}Bitte bewegen Sie
                den Schieberegler{% endif %}
              </p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</form>

<p>{{instruction_text_batch}}</p>

<div style="display: flex; justify-content: space-between; align-items: center">
  {% if lan_en %}
  <button type="submit" class="otree-btn-next btn btn-primary big-button">
    Continue
  </button>
  <div style="margin-left: auto">Page {{nslide}}/{{maxslides}}</div>
  {% else %}
  <button type="submit" class="otree-btn-next btn btn-primary big-button">
    Weiter
  </button>
  <div style="margin-left: auto">Seite {{nslide}}/{{maxslides}}</div>
  {% endif %}
</div>

<script>
  let slidersTouched = {};
  let totalSliders = 0;

  function handleSliderInput(field, value) {
      slidersTouched[field] = true;
      const numVal = parseInt(value, 10);
      let label = getLikertLabel(value, "{{lan_en}}")
      // update text under slider
      const div = document.getElementById('sliderValue' + field);
      if (div) {
          div.innerHTML = `<p style="font-size: 10pt; margin-top:0pt">
              <strong>${label}</strong>
          </p>`;
          div.style.color = 'black';
      }

      // update slider gradient
      const slider = document.getElementById('slider_' + field);
      if (slider) {
          const val = parseFloat(value);
          const min = parseFloat(slider.min), max = parseFloat(slider.max);
          const mid = (min + max) / 2;
          const sliderColor = "{{ color }}";

          const l = val < mid ? Math.max(0, 50 + ((val - mid) / (mid - min)) * 50) : 50;
          const r = val < mid ? 50 : Math.min(100, 50 + ((val - mid) / (max - mid)) * 50);

          slider.style.background = `linear-gradient(to right,
            #e0e0e0 0%, #e0e0e0 ${l}%,
            ${sliderColor} ${l}%, ${sliderColor} ${r}%,
            #e0e0e0 ${r}%, #e0e0e0 100%)`;
      }

      // enable next button if all touched
      if (Object.keys(slidersTouched).length === totalSliders) {
          const nextButton = document.getElementById('nextButton') || document.querySelector('.otree-btn-next');
          if (nextButton) {
              nextButton.disabled = false;
              nextButton.style.opacity = '1';
          }
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
      totalSliders = document.querySelectorAll('.likert-slider').length;

      const form = document.querySelector('form');
      if (form) {
          form.addEventListener('submit', function(e) {
              if (Object.keys(slidersTouched).length < totalSliders) {
                  e.preventDefault();
                  alert({% if lan_en %}'Please move all sliders to select values.'{% else %}'Bitte bewegen Sie alle Schieberegler, um Werte auszuwÃ¤hlen.'{% endif %});
                  return false;
              }
          });
      }

      const nextButton = document.getElementById('nextButton') || document.querySelector('.otree-btn-next');
      if (nextButton) {
          nextButton.disabled = true;
          nextButton.style.opacity = '0.5';
      }
  });
</script>

{% endblock %}
